
VPATH=.:./.git/refs/heads/

gitmake-all: cargodist diaglvl
	touch gitmake-all

check: clean gitmake-origin
	echo "check OK"

clean:
	rm -f gitmake-origin
	rm -f patches/current/*

%:
	git checkout master
	git branch gitmake-tmp
	git checkout gitmake-tmp
	for branch in $(^F); do git merge $${branch}; done 
	git checkout $@
	git merge gitmake-tmp
	./make_diffs
	git branch -D gitmake-tmp
	make -j4
	

gitmake-origin: 
	git fetch origin
	git log origin | grep -m 1 '(svn r[0-9]*)' | awk '{print $$2}' | sed -e 's/)//' > gitmake-origin
	cp gitmake-origin patches/current/TRUNK_VERSION
	git diff --numstat origin/master master | grep -v .gitignore | grep -v gitmake && touch gitmake-origin || touch -t 197001010100 gitmake-origin

master: gitmake-origin
	git checkout $@
	git pull
	make -j4

smallmap-zoom-out: master

zoomlevels: master

smallmap-zoom-in: smallmap-zoom-out zoomlevels 

cargodist: station-gui smallmap-stats

station-gui: cargomap

smallmap-stats: smallmap-zoom-in cargomap

texteff: master

flowmapping-core: mcf

mcf: demands

demands: components

components: capacities

capacities: master

diaglvl: tileiter

tileiter: master

cargomap: flowmapping-core texteff multimap cargoset

multimap: master

slset: master

cargoset: slset

push: master cargodist station-gui smallmap-stats flowmapping-core mcf demands components capacities smallmap-zoom-in smallmap-zoom-out zoomlevels diaglvl tileiter texteff cargomap multimap slset cargoset
	git push ulf@laramies.com:~/fonsinchen/openttd.git $(^F)
	rsync -av --delete patches ulf@laramies.com:~/fonsinchen/
	
	
