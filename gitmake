
VPATH=.:./.git/refs/heads/

gitmake-all: cdo cd diaglvl alteconomy autogrow-goodsentries
	touch gitmake-all

check: clean gitmake-origin
	echo "check OK"

clean:
	rm -f gitmake-origin
	rm -f patches/current/*

%:
	git checkout ${@}-tmp
	for branch in $(^F); do git merge $${branch}; done 
	git checkout $@
	git merge ${@}-tmp
	test -e gitmake-build && make -j`cat gitmake-build` || true
	./make_diffs

gitmake-origin:
	git fetch git://git.openttd.org/openttd/trunk.git master:trunk
	git log trunk | grep -m 1 '(svn r[0-9]*)' | awk '{print $$2}' | sed -e 's/)//' > gitmake-origin
	cp gitmake-origin patches/current/TRUNK_VERSION.txt
	git diff --numstat trunk master | grep -v .gitignore | grep -v gitmake | grep -v make_diffs && touch gitmake-origin || touch -t 197001010100 gitmake-origin

master: gitmake-origin
	git checkout $@
	git merge trunk
	test -e gitmake-build && make -j`cat gitmake-build` || true

findversion: master

smallmap-zoom-in: findversion 

global-acceptance: findversion

supplyscale: components global-acceptance

cdo: station-gui smallmap-stats warning-sign supplyscale

cd: station-gui smallmap-stats warning-sign ext-rating

ext-rating: cargomap

station-gui: cargomap

smallmap-stats: smallmap-zoom-in cargomap

texteff: findversion

flowmapping-core: mcf

mcf: demands

demands: components

components: capacities

capacities: moving-average

diaglvl: tileiter

tileiter: findversion

selfaware-stationcargo: findversion

cargomap: flowmapping-core texteff multimap reservation selfaware-stationcargo

reservation: findversion

multimap: findversion

warning-sign: demands

moving-average: findversion

alteconomy-switch: findversion

delivery-rating: alteconomy-switch global-acceptance

rating-weight: delivery-rating

rating-payment: delivery-rating

score: alteconomy-switch

alteconomy: rating-payment rating-weight score

autogrow-vector: findversion

pool-copy: findversion

autogrow-goodsentries: autogrow-vector pool-copy

push: master cdo cd ext-rating station-gui smallmap-stats flowmapping-core mcf demands components capacities smallmap-zoom-in diaglvl tileiter texteff cargomap multimap reservation warning-sign moving-average supplyscale delivery-rating rating-weight rating-payment alteconomy global-acceptance alteconomy-switch score autogrow-vector autogrow-goodsentries pool-copy selfaware-stationcargo findversion
	git push ulf@laramies.com:~/fonsinchen/openttd.git $(^F)
	rsync -av --delete patches ulf@laramies.com:~/fonsinchen/

